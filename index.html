<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BAYFM78 坂本真綾の『ビタミンM』</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1c6ed5">

  <style>
    :root {
      --bayfm-blue: #1c6ed5;
      --bayfm-light-blue: #e8f1fb;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fff;
      color: #222;
    }

    .banner {
      width: 100%;
      aspect-ratio: 1200 / 300;
      background: url("title.png") center / cover no-repeat;
    }

    .container {
      max-width: 760px;
      margin: auto;
      padding: 16px;
    }

    h1 {
      font-size: 20px;
      color: var(--bayfm-blue);
      margin: 16px 0;
    }

    h2 {
      font-size: 18px;
      margin: 24px 0 12px;
      border-left: 5px solid var(--bayfm-blue);
      padding-left: 10px;
    }

    /* ===== 状態表示 ===== */
    .status {
      text-align: center;
      padding: 16px;
      font-size: 15px;
      color: var(--bayfm-blue);
    }

    .error {
      color: #c0392b;
    }

    .retry-btn {
      margin-top: 12px;
      padding: 10px 14px;
      font-size: 15px;
      border-radius: 8px;
      border: none;
      background: var(--bayfm-blue);
      color: #fff;
    }

    /* ===== 放送回一覧 ===== */
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      margin-bottom: 10px;
      background: var(--bayfm-light-blue);
      border-radius: 10px;
    }

    li.playing {
      border-left: 6px solid var(--bayfm-blue);
      background: #dcecff;
    }

    input[type="radio"] {
      width: 22px;
      height: 22px;
      accent-color: var(--bayfm-blue);
    }

    label {
      flex: 1;
      font-size: 16px;
      cursor: pointer;
    }

    /* ===== メイン再生ボタン ===== */
    .play-main-btn {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      background: var(--bayfm-blue);
      color: #fff;
      margin: 16px 0;
    }

    /* ===== プレイヤー ===== */
    audio {
      width: 100%;
      margin: 10px 0 24px;
    }

    .player-controls,
    .speed-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .player-controls button,
    .speed-controls button {
      flex: 1;
      background: #fff;
      border: 2px solid var(--bayfm-blue);
      color: var(--bayfm-blue);
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
    }

    .speed-controls button.active {
      background: var(--bayfm-blue);
      color: #fff;
    }
  </style>
</head>
<body>

<div class="banner"></div>

<div class="container">
  <h1>BAYFM78 坂本真綾の『ビタミンM』</h1>

  <h2>放送回一覧</h2>

  <div id="status" class="status">
    ⏳ 放送回一覧を取得しています…
  </div>

  <ul id="mp3List"></ul>

  <button id="playBtn" class="play-main-btn">
    選択した回を再生
  </button>

  <h2>再生プレイヤー</h2>

  <div class="player-controls">
    <button id="back10">⏪ 10秒</button>
    <button id="forward30">⏩ 30秒</button>
  </div>

  <div class="speed-controls">
    <button data-speed="1">1.0x</button>
    <button data-speed="1.25">1.25x</button>
    <button data-speed="1.5">1.5x</button>
  </div>

  <audio id="player" controls></audio>
</div>

<script>
const mp3List = document.getElementById("mp3List");
const statusEl = document.getElementById("status");
const playBtn = document.getElementById("playBtn");
const player = document.getElementById("player");

const back10 = document.getElementById("back10");
const forward30 = document.getElementById("forward30");
const speedButtons = document.querySelectorAll(".speed-controls button");

const PROGRAM_NAME = "『ビタミンM』";
const STORAGE_EPISODE = "vitaminm_selected_episode";
const STORAGE_TIME_PREFIX = "vitaminm_play_time_";
const STORAGE_SPEED = "vitaminm_play_speed";

let allItems = [];
let currentEpisodeKey = null;
let currentLi = null;

/* ===== 再生操作 ===== */
back10.onclick = () => {
  player.currentTime = Math.max(0, player.currentTime - 10);
};

forward30.onclick = () => {
  if (!isNaN(player.duration)) {
    player.currentTime = Math.min(player.duration, player.currentTime + 30);
  }
};

/* ===== 再生速度 ===== */
function setSpeed(speed) {
  player.playbackRate = speed;
  localStorage.setItem(STORAGE_SPEED, speed);
  speedButtons.forEach(btn =>
    btn.classList.toggle("active", btn.dataset.speed == speed)
  );
}

speedButtons.forEach(btn => {
  btn.onclick = () => setSpeed(btn.dataset.speed);
});

/* ===== 放送回一覧取得 ===== */
async function fetchList() {
  statusEl.textContent = "⏳ 放送回一覧を取得しています…";
  statusEl.className = "status";
  mp3List.innerHTML = "";

  const target =
    "https://api.allorigins.win/raw?url=" +
    encodeURIComponent(
      "https://omny.fm/shows/bayfm-program04/playlists/maaya/embed?style=cover/playlists/podcast/embed?style=cover"
    );

  try {
    const res = await fetch(target);
    const html = await res.text();

    const mp3Urls = [...html.matchAll(/"(https?:\/\/[^"]+mp3[^"]*)"/g)].map(m => m[1]);
    const episodes = [...html.matchAll(/"Episode"\s*:\s*(20\d{6})/g)].map(m => m[1]);

    allItems = mp3Urls.map((url, i) => ({
      url,
      episode: episodes[i],
      date: episodes[i]
        ? `${episodes[i].slice(0,4)}年${episodes[i].slice(4,6)}月${episodes[i].slice(6,8)}日`
        : "日付不明"
    })).sort((a, b) => (b.episode || "").localeCompare(a.episode || ""));

    const savedEpisode = localStorage.getItem(STORAGE_EPISODE);

    allItems.forEach((item, index) => {
      const li = document.createElement("li");
      const radio = document.createElement("input");
      radio.type = "radio";
      radio.name = "episode";
      radio.value = index;

      if (item.episode === savedEpisode || (!savedEpisode && index === 0)) {
        radio.checked = true;
        currentEpisodeKey = item.episode;
      }

      radio.onchange = () => {
        localStorage.setItem(STORAGE_EPISODE, item.episode);
        currentEpisodeKey = item.episode;
      };

      const label = document.createElement("label");
      label.textContent = `${PROGRAM_NAME} ${item.date}`;

      li.append(radio, label);
      mp3List.appendChild(li);
    });

    statusEl.textContent = "";

  } catch {
    statusEl.innerHTML = `
      <div class="error">⚠ 放送回一覧の取得に失敗しました</div>
      <button class="retry-btn" onclick="fetchList()">再試行</button>
    `;
  }
}

/* ===== 再生 ===== */
playBtn.onclick = () => {
  const selected = mp3List.querySelector("input[type=radio]:checked");
  if (!selected) return;

  const item = allItems[selected.value];
  const li = mp3List.children[selected.value];

  if (currentLi) currentLi.classList.remove("playing");
  li.classList.add("playing");
  currentLi = li;

  player.src = item.url;
  currentEpisodeKey = item.episode;

  player.onloadedmetadata = () => {
    const t = localStorage.getItem(STORAGE_TIME_PREFIX + currentEpisodeKey);
    if (t) player.currentTime = parseFloat(t);
    setSpeed(localStorage.getItem(STORAGE_SPEED) || 1);
  };

  player.play();
};

/* ===== 再生位置保存 ===== */
player.addEventListener("timeupdate", () => {
  if (currentEpisodeKey) {
    localStorage.setItem(
      STORAGE_TIME_PREFIX + currentEpisodeKey,
      player.currentTime
    );
  }
});

/* ===== 起動時 ===== */
fetchList();
setSpeed(localStorage.getItem(STORAGE_SPEED) || 1);

/* ===== Service Worker ===== */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker-v3.js');
}
</script>

</body>
</html>
